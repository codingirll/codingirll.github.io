# 熔断、限流、降级

### 熔断

解决的问题：在服务端出现问题的时候拒绝新的请求，直到恢复正常，给服务端恢复的机会。



> 推理网关是要做熔断的，因为下游模型实例的故障或高延迟会导致网关的cpu、内存、网络连接、线程等资源被耗尽，导致网关崩溃。 熔断设计围绕怎么判断熔断、怎么熔断以及怎么恢复三个点开展。
>
> AI推理服务对延迟敏感，网关根据下游响应时间作为判断条件，产品要求1s，阈值设定为1.2s。也不是说只要超过1.2s就马上熔断，很可能是抖动，所以是用滑动窗口统计30s内超时比例，超过50%就触发熔断。
>
> 熔断期间所有对该实例的请求不会真正发出，会立马返回失败响应，这样就能将故障隔离，网关保护好资源区处理其他健康实例的请求。
>
> 恢复是根据经验值取30s自动恢复的，如果能够逐步放开流量可能会更好。

### 降级

好处：牺牲不那么重要的部分保证更重要的部分。腾出服务器资源，同时减少对公共组件的压力。

示例：首页个性化推送改为静态页面。

常见方案：

* 跨服务：停整个服务，停部分节点

* 本服务：禁用埋点、同步转异步（先返回已接收再异步起线程或利用定时任务）、简化流程

### 限流

解决的问题：防止流量过大打崩系统的问题。

常见算法：

* 静态算法：漏桶、令牌桶、固定窗口、滑动窗口。(令牌桶和滑动窗口能解决突发流量。)
* 动态算法：借鉴TCP拥塞控制

关键是阈值设置，太大会把系统打崩，太小资源会闲置浪费。

> 推理网关的限流用了滑动窗口的计算方法。阈值的选择是计算+手动分配确定的。要根据底层模型实例的压测结果算出总的额度，网关限流阈值在此基础上留一点余量。这个总量分配的时候，优先给大客户分，剩下的分配给普通用户，普通用户的流量会再次按照模型种类进行限流。 最初的阈值一般是比较低的，上线后观测性能指标会调高一些阈值。

### 隔离

解决的问题：防止故障的相互影响

方案：机房隔离、实例隔离、第三方依赖隔离

### 超时控制

解决的问题：

1.确保用户在预期的时间内拿到响应，提示超时也比一直等待要好

2.及时释放资源，比如线程、连接等。

注意点：过短会频繁超时，过长会资源释放不及时

如何确定超时时间？

* 根据用户需求
* 根据下游接口响应时间99线

> 对第三方的调用都会设置超时时间，重试



### 高可用

一般用SLA指标衡量系统的可用性，高可用指定的一般是三个九以上。


# NoSQL

## Elasticsearch

场景：

- 电商商品搜索引擎，支持多条件查询、排序、聚合
- 知识库的文档查询
- 海量日志 过滤出某个等级、某个服务或包含某些字符的日志



优点：

- ES先分词，再根据倒排索引快速定位包含该词条的文档，无需扫描所有文档。
- 近实时：文档索引后，1s内可以被搜索到
- 天然的分布式结构，保证高可用高性能。


机制：
- 核心是分片，每个分片有主从之分，主分片崩溃可以使用从分片。写入数据时先写入自己的buffer，记录translog，定时刷新到操作系统的page cache，后面再刷新到磁盘。
- 多个节点：数据节点存储数据，执行数据相关操作。协调节点接受客户端请求，路由到数据节点返回给客户端
- 倒排索引，成千上万的关键词，怎么找到想要的词？
- es采用了分层结构，用最小的内存开销，实现最快的查询速度。第一层是一个类似于前缀树的FST，用于快速缩小搜索范围，定位到第二层的block。再由block定位到第三层的Floor Block。第三层的数据就比较少了，顺序遍历找到就行。

## MongoDB

文档型NoSQL数据库，优点：

- 数据模型灵活，不用预先定义严格的表结构，每个文档的结构可以不同，字段可以随时添加
- 天然支持分片，自动的横向扩展。分片能做数据量的负载均衡，保证每个分片数据量差不多。
- 高写入吞吐量，TTL索引

索引要符合ESR规则，先等值，再排序，后范围。

优化方法：
- 尽量不要加载整个文档，指定字段，这些字段是索引字段
- 避免内存排序，利用索引来排序
- 增加mongos数量，分片集合要由mongos执行路由合并结果集

场景：

- 存用户画像，不同用户画像包含的字段不一样，数据库要预留大量字段
- 日志系统，insertMany()批量写入，结合TTL索引自动删除旧数据(l冷存储库)
- 朋友圈信息流，避免数据库查多个表进行join。


对比：
mongoDB是负责存储和精确查询，而es是搜索引擎，负责海量数据的模糊检索和复杂分析。



参考网站：

https://dhexx.cn/hk/5448391.html?action=onClick

https://developer.aliyun.com/article/862184